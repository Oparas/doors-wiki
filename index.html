<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Doors Wiki Online</title>

<script type="module">
/* -------------------- Firebase SDK Imports -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot }
  from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* -------------------- Firebase Config -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDiVVLyuswljX045vy3OlOzzelA2SIBDYA",
  authDomain: "howtoplaydoors.firebaseapp.com",
  projectId: "howtoplaydoors",
  storageBucket: "howtoplaydoors.firebasestorage.app",
  messagingSenderId: "909503530350",
  appId: "1:909503530350:web:b924362e30160a4ada2d7f",
  measurementId: "G-28MXWZRS18"
};

/* -------------------- Initialize Firebase -------------------- */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* -------------------- Zones -------------------- */
const zones = ["Backdoors", "Hotel", "The Rooms", "The Outdoors", "The Mines"];
const zoneCache = {};

/* -------------------- DOM Loaded -------------------- */
window.onload = () => {
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginPanel = document.getElementById("loginPanel");
  const adminPanel = document.getElementById("adminPanel");
  const userName = document.getElementById("userName");

  const zoneSelect = document.getElementById("zoneSelect");
  const zoneEditor = document.getElementById("zoneEditor");
  const saveBtn = document.getElementById("saveBtn");
  const displayContent = document.getElementById("displayContent");

  /* ---- Populate Zone Select ---- */
  zones.forEach(z => {
    const op = document.createElement("option");
    op.value = z;
    op.innerText = z;
    zoneSelect.appendChild(op);
  });

  /* ---- Login ---- */
  loginBtn.onclick = () => {
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider).catch(err => {
      alert("Login failed: " + err.message);
      console.error(err);
    });
  };

  /* ---- Logout ---- */
  logoutBtn.onclick = () => signOut(auth);

  /* ---- Auth State ---- */
  onAuthStateChanged(auth, user => {
    if (user) {
      loginPanel.style.display = "none";
      adminPanel.style.display = "block";
      userName.textContent = user.displayName;
    } else {
      loginPanel.style.display = "block";
      adminPanel.style.display = "none";
    }
  });

  /* ---- Load Realtime Data ---- */
  zones.forEach(zone => {
    const ref = doc(db, "zones", zone);
    onSnapshot(ref, snap => {
      zoneCache[zone] = snap.exists() ? snap.data().content : "";
      if (zoneSelect.value === zone) {
        zoneEditor.value = zoneCache[zone] || "";
        displayContent.innerHTML = zoneCache[zone] || "";
      }
    });
  });

  /* ---- Change Zone ---- */
  zoneSelect.onchange = () => {
    const zone = zoneSelect.value;
    zoneEditor.value = zoneCache[zone] || "";
    displayContent.innerHTML = zoneCache[zone] || "";
  };

  /* ---- Save ---- */
  saveBtn.onclick = async () => {
    const zone = zoneSelect.value;
    const text = zoneEditor.value;

    await setDoc(doc(db, "zones", zone), { content: text });
    alert("บันทึกข้อมูลแล้ว ✔");
  };
};
</script>

<style>
body { font-family: Arial; padding: 20px; background: #e9e9e9; }
.container { max-width: 900px; margin:auto; background:#fff; padding:20px; border-radius:10px; }
textarea { width:100%; height:120px; }
button { padding:8px 14px; margin:5px; }
#displayContent img { max-width: 100%; }
</style>
</head>

<body>
<div class="container">
  <h1>Doors Wiki Online</h1>

  <!-- Login Panel -->
  <div id="loginPanel">
    <button id="loginBtn">Login with Google</button>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <p>ล็อกอินเป็น: <b id="userName"></b> <button id="logoutBtn">ออกจากระบบ</button></p>

    <select id="zoneSelect"></select>
    <textarea id="zoneEditor" placeholder="ใส่ HTML / ข้อความเกี่ยวกับ Floor นี้"></textarea>
    <button id="saveBtn">บันทึก</button>
  </div>

  <hr>

  <h2>ข้อมูล Floors</h2>
  <div id="displayContent"></div>
</div>
</body>
</html>